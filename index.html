<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Short Term Memory Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="images/icon.png" />
    <style>
      /* Layout: Instructions sidebar + game area */
      body {
        display: flex;
        height: 100vh;
      }
      #instructions {
        width: 250px;
        flex-shrink: 0;
      }
      #gameArea {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
      }

      /* Container for displaying big shapes */
      #bigShapeContainer {
        margin-bottom: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 250px;
      }

      /* Error messages for selects */
      .errorMsg {
        color: red;
        font-size: 0.9rem;
        margin-top: 2px;
      }

      /* Timer label */
      #timerLabel {
        font-weight: bold;
        color: red;
        margin-left: 10px;
      }
    </style>
  </head>
  <body class="bg-gray-100 font-sans">
    <!-- Sidebar instructions always visible -->
    <div
      id="instructions"
      class="p-4 bg-yellow-50 border border-yellow-200 rounded m-4 h-full"
    >
      <h2 class="font-semibold text-lg mb-2">Game Instructions</h2>
      <p>Press <strong>Start</strong> to begin a 4-round game.</p>
      <p>
        At the start of each round, you will see a sequence of colored geometric
        shapes.
      </p>
      <p>
        After the display, select the last N shapes in
        <strong>reverse order</strong>.
      </p>
      <p id="statusLabel" class="mt-2 font-medium text-blue-600"></p>
    </div>

    <!-- Main game area -->
    <div id="gameArea">
      <!-- Start button and round info -->
      <div class="flex items-center gap-6 mb-6">
        <button
          id="startBtn"
          class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
        >
          Start
        </button>
        <div id="roundInfo" class="ml-auto text-sm text-gray-600">
          Round: <span id="roundNum">0</span>/4
          <span id="timerLabel"></span>
        </div>
      </div>

      <!-- Display area for shapes -->
      <div
        id="displayArea"
        class="flex flex-col items-center justify-center bg-gray-50 border border-gray-200 rounded mb-6 h-64"
      >
        <div id="bigShapeContainer"></div>
      </div>

      <!-- Selection area for user input -->
      <div
        id="selectionArea"
        class="hidden p-4 bg-white border rounded space-y-4 mb-6"
      >
        <h3 class="font-semibold">
          Select the last <span id="selectCount">N</span> shapes in reverse
          order
        </h3>
        <form id="selectionForm" class="space-y-3">
          <div id="selectsContainer" class="flex flex-col gap-3"></div>
          <button
            type="submit"
            class="px-4 py-2 bg-green-600 text-white rounded"
          >
            Submit
          </button>
        </form>
      </div>

      <!-- Summary area at the end of game -->
      <div
        id="summaryArea"
        class="hidden p-4 bg-indigo-50 border rounded flex flex-col items-center justify-center"
      >
        <h3 class="font-semibold text-lg mb-2">Final Results</h3>
        <div id="summaryText" class="mb-4 text-center"></div>
        <button
          id="playAgainBtn"
          class="px-3 py-2 bg-blue-600 text-white rounded"
        >
          Play Again
        </button>
      </div>
    </div>

    <script>
      // ---------------- Constants and DOM references ----------------
      const COLORS = ["red", "blue", "green", "yellow"];
      const SHAPES = ["square", "ring", "star", "circle", "triangle"];
      const roundsConfig = [2, 3, 4, 5]; // Number of shapes to select per round
      const SELECT_TIME = 25; // seconds for user selection

      const startBtn = document.getElementById("startBtn");
      const roundNum = document.getElementById("roundNum");
      const selectCount = document.getElementById("selectCount");
      const bigContainer = document.getElementById("bigShapeContainer");
      const selectionArea = document.getElementById("selectionArea");
      const selectsContainer = document.getElementById("selectsContainer");
      const selectionForm = document.getElementById("selectionForm");
      const summaryArea = document.getElementById("summaryArea");
      const summaryText = document.getElementById("summaryText");
      const playAgainBtn = document.getElementById("playAgainBtn");
      const statusLabel = document.getElementById("statusLabel");
      const timerLabel = document.getElementById("timerLabel");
      const displayArea = document.getElementById("displayArea");

      let round = 0; // current round index
      let results = []; // array to store correct answers per round
      let timerInterval; // selection timer

      // ---------------- SVG Shape Generation ----------------
      function createShapeSVG(shape, color, size = 250) {
        const center = size / 2;
        const r = Math.min(100, size * 0.35);
        let strokeColor = color === "yellow" ? "gray" : color; // yellow shapes get gray stroke
        let strokeWidth = color === "yellow" ? 2 : 4; // thin for yellow

        let inner = "";

        if (shape === "square") {
          const s = r * 1.4;
          inner = `<rect x="${center - s / 2}" y="${
            center - s / 2
          }" width="${s}" height="${s}" rx="12" fill="${color}" stroke="${strokeColor}" stroke-width="${strokeWidth}"/>`;
        } else if (shape === "ring") {
          inner = `<circle cx="${center}" cy="${center}" r="${r}" fill="none" stroke="${strokeColor}" stroke-width="${
            strokeWidth * 4
          }"/>`;
        } else if (shape === "circle") {
          inner = `<circle cx="${center}" cy="${center}" r="${r}" fill="${color}" stroke="${strokeColor}" stroke-width="${strokeWidth}"/>`;
        } else if (shape === "triangle") {
          const p1 = `${center},${center - r}`;
          const p2 = `${center - r},${center + r}`;
          const p3 = `${center + r},${center + r}`;
          inner = `<polygon points="${p1} ${p2} ${p3}" fill="${color}" stroke="${strokeColor}" stroke-width="${strokeWidth}"/>`;
        } else if (shape === "star") {
          const points = [];
          for (let i = 0; i < 5; i++) {
            const ang = Math.PI / 2 + (i * 2 * Math.PI) / 5;
            const x = center + Math.cos(ang) * r;
            const y = center - Math.sin(ang) * r;
            points.push(`${x},${y}`);
            const ang2 = ang + Math.PI / 5;
            const x2 = center + Math.cos(ang2) * (r * 0.45);
            const y2 = center - Math.sin(ang2) * (r * 0.45);
            points.push(`${x2},${y2}`);
          }
          inner = `<polygon points="${points.join(
            " "
          )}" fill="${color}" stroke="${strokeColor}" stroke-width="${
            strokeWidth * 0.75
          }"/>`;
        }

        const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}' viewBox='0 0 ${size} ${size}'>${inner}</svg>`;
        return "data:image/svg+xml;utf8," + encodeURIComponent(svg);
      }

      // ---------------- Display a single big shape ----------------
      function showBigShape(shape, color) {
        bigContainer.innerHTML = "";
        const img = document.createElement("img");
        img.width = 250;
        img.height = 250;
        img.src = createShapeSVG(shape, color, 250);
        bigContainer.appendChild(img);
      }

      function clearBigShape() {
        bigContainer.innerHTML = "";
      }

      // ---------------- Event listeners ----------------
      startBtn.addEventListener("click", startGame);
      playAgainBtn.addEventListener("click", () => location.reload());

      // ---------------- Game logic ----------------
      function startGame() {
        round = 0;
        results = [];
        startBtn.style.display = "none"; // hide start button during game
        nextRound();
      }

      async function nextRound() {
        if (round >= roundsConfig.length) {
          showSummary();
          return;
        }

        const need = roundsConfig[round];
        roundNum.textContent = round + 1;
        selectCount.textContent = need;

        statusLabel.textContent = `Round ${
          round + 1
        }: Memorize the shapes displayed.`;

        // Generate a random number of shapes between 10-19
        const seqLen = Math.floor(Math.random() * (19 - 10 + 1)) + 10;
        const seq = [];
        let prev = null;
        for (let i = 0; i < seqLen; i++) {
          let next;
          do {
            // avoid consecutive identical shapes
            next = {
              color: COLORS[Math.floor(Math.random() * COLORS.length)],
              shape: SHAPES[Math.floor(Math.random() * SHAPES.length)],
            };
          } while (
            prev &&
            next.color === prev.color &&
            next.shape === prev.shape
          );
          seq.push(next);
          prev = next;
        }

        await playSequence(seq);

        // Begin user selection phase
        displayArea.style.display = "none";
        buildSelects(need);
        selectionArea.classList.remove("hidden");
        statusLabel.textContent = `Round ${
          round + 1
        }: Select the last ${need} shapes in reverse order`;

        const expected = seq
          .slice(-need)
          .reverse()
          .map((c) => c.color + "-" + c.shape);

        // Timer for selection phase
        let timeLeft = SELECT_TIME;
        timerLabel.textContent = `Time left: ${timeLeft}s`;
        timerInterval = setInterval(() => {
          timeLeft--;
          timerLabel.textContent = `Time left: ${timeLeft}s`;
          if (timeLeft <= 0) {
            clearInterval(timerInterval);
            submitAnswers(true);
          }
        }, 1000);

        // Form submit
        selectionForm.onsubmit = (e) => {
          e.preventDefault();
          submitAnswers(false);
        };

        function submitAnswers(expired) {
          clearInterval(timerInterval);
          const selects = document.querySelectorAll("#selectsContainer select");
          let incomplete = false;

          selects.forEach((s) => {
            let msg = s.nextElementSibling;
            if (msg && msg.classList.contains("errorMsg")) msg.remove();
            if (!s.value) incomplete = true;
          });

          if (!expired && incomplete) {
            // show inline errors
            selects.forEach((s) => {
              if (!s.value) {
                const msg = document.createElement("div");
                msg.textContent = "Please select a value!";
                msg.className = "errorMsg";
                s.parentNode.appendChild(msg);
              }
            });
            return;
          }

          // Check correctness
          let correct = 0;
          for (let i = 0; i < expected.length; i++) {
            if (selects[i].value === expected[i]) correct++;
          }

          results.push({ correct, total: expected.length });
          selectionArea.classList.add("hidden");
          clearBigShape();
          round++;
          displayArea.style.display = "flex";
          timerLabel.textContent = "";
          nextRound();
        }
      }

      // ---------------- Play sequence of shapes ----------------
      function playSequence(seq) {
        return new Promise((resolve) => {
          let i = 0;
          function step() {
            if (i >= seq.length) {
              clearBigShape();
              return resolve();
            }
            showBigShape(seq[i].shape, seq[i].color);
            i++;
            setTimeout(step, 2500); // show each shape for 2.5 seconds
          }
          step();
        });
      }

      // ---------------- Build select elements for user input ----------------
      function buildSelects(count) {
        selectsContainer.innerHTML = "";
        for (let i = 0; i < count; i++) {
          const wrapper = document.createElement("div");
          wrapper.className = "flex flex-col";
          const label = document.createElement("label");
          label.textContent = `Shape ${i + 1} from last`;
          label.className = "mb-1 font-medium";
          const sel = document.createElement("select");
          sel.className = "border rounded px-2 py-1";
          const opt0 = document.createElement("option");
          opt0.value = "";
          opt0.textContent = "-- choose --";
          sel.appendChild(opt0);
          for (const c of COLORS) {
            for (const s of SHAPES) {
              const opt = document.createElement("option");
              opt.value = c + "-" + s;
              opt.textContent = c + " " + s;
              sel.appendChild(opt);
            }
          }
          wrapper.appendChild(label);
          wrapper.appendChild(sel);
          selectsContainer.appendChild(wrapper);
        }
      }

      // ---------------- Show final summary ----------------
      function showSummary() {
        let totalCorrect = 0,
          total = 0;
        results.forEach((r) => {
          totalCorrect += r.correct;
          total += r.total;
        });
        const percent = Math.round((totalCorrect / total) * 100);
        summaryText.innerHTML = `Correct: ${totalCorrect}/${total} <br/>Percentage: ${percent}%`;
        summaryArea.classList.remove("hidden");
        statusLabel.textContent = "";
        timerLabel.textContent = "";
        displayArea.style.display = "none";
      }
    </script>
  </body>
</html>
